<div id="knowledge-explorer">
  <div class="explorer-header">
    <div class="elb-row">
      <button class="elb active" data-layer="structure">Structure</button>
      <span class="elb-sep">&middot;</span>
      <button class="elb" data-layer="people">People</button>
      <span class="elb-sep">&middot;</span>
      <button class="elb" data-layer="topics">Topics</button>
    </div>
    <div class="explorer-search-wrap">
      <input type="text" class="explorer-search" placeholder="Filter by label..." />
      <button class="explorer-search-btn">FILTER</button>
    </div>
  </div>
  <div class="explorer-canvas">
    <svg id="explorer-svg"></svg>
    <div class="explorer-layers" id="explorer-layers">
      <button class="explorer-layer-btn" data-layer="structure">Structure</button>
      <button class="explorer-layer-btn" data-layer="people">People</button>
      <button class="explorer-layer-btn" data-layer="topics">Topics</button>
    </div>
  </div>
  <div id="explorer-detail" class="explorer-detail">
    <button class="explorer-detail-close">&times;</button>
    <div class="explorer-detail-content"></div>
  </div>
</div>

<style>
  @import url('https://fonts.googleapis.com/css2?family=IBM+Plex+Mono:wght@400;500;600;700&display=swap');

  /* Dark scrollbars inside iframe */
  * {
    scrollbar-width: thin;
    scrollbar-color: #1a1f2e #0a0d13;
  }
  *::-webkit-scrollbar { width: 6px; height: 6px; }
  *::-webkit-scrollbar-track { background: #0a0d13; }
  *::-webkit-scrollbar-thumb { background: #1a1f2e; border-radius: 3px; }
  *::-webkit-scrollbar-thumb:hover { background: #2a3048; }

  html, body {
    margin: 0;
    padding: 0;
    width: 100%;
    height: 100%;
    overflow: hidden;
    background: #0a0d13;
  }

  #knowledge-explorer {
    position: relative;
    width: 100%;
    height: 100%;
    background: #0a0d13;
    border-radius: 6px;
    overflow: hidden;
    font-family: 'IBM Plex Mono', 'Fira Code', monospace;
    color: #c8d0e0;
    display: flex;
    flex-direction: column;
  }

  /* ── Header (search + layer tabs) ────────────── */
  #knowledge-explorer .explorer-header {
    display: flex;
    align-items: center;
    gap: 8px;
    padding: 5px 12px;
    background: #0e1219;
    border-bottom: 1px solid #1a1f2e;
    flex-shrink: 0;
    flex-wrap: wrap;
  }

  #knowledge-explorer .explorer-search-wrap {
    display: flex;
    flex: 0 1 auto;
    margin-left: auto;
    max-width: 220px;
    min-width: 120px;
    background: #0a0d13;
    border: 1px solid #1a1f2e;
    border-radius: 6px;
    overflow: hidden;
  }

  #knowledge-explorer .explorer-search {
    flex: 1;
    background: transparent;
    border: none;
    outline: none;
    color: #c8d0e0;
    padding: 5px 10px;
    font-size: 10px;
    font-family: inherit;
  }

  #knowledge-explorer .explorer-search-btn {
    background: transparent;
    border: none;
    border-left: 1px solid #1a1f2e;
    color: #c45c4a;
    padding: 5px 10px;
    cursor: pointer;
    font-size: 8px;
    font-weight: 600;
    font-family: inherit;
    letter-spacing: 0.5px;
  }

  /* ── Layer tabs (left side of header) ──────── */
  .elb-row {
    display: flex;
    align-items: center;
    gap: 0;
  }
  .elb {
    font-size: 8px;
    letter-spacing: 0.6px;
    padding: 4px 8px;
    color: #3e4a64;
    background: transparent;
    border: none;
    border-bottom: 2px solid transparent;
    transition: all 0.2s;
    font-family: 'IBM Plex Mono', monospace;
    cursor: pointer;
    white-space: nowrap;
  }
  .elb::before {
    content: "\25CF";
    font-size: 5px;
    margin-right: 5px;
    vertical-align: middle;
    opacity: 0.4;
  }
  .elb:hover { color: #5a6580; }
  .elb.active {
    color: #c45c4a;
    border-bottom-color: #c45c4a;
  }
  .elb.active::before {
    opacity: 1;
    color: #c45c4a;
  }
  .elb-sep {
    color: #1a1f2e;
    font-size: 10px;
    margin: 0 1px;
  }

  /* ── Canvas ───────────────────────────────────── */
  #knowledge-explorer .explorer-canvas {
    flex: 1;
    position: relative;
    background: radial-gradient(ellipse at 50% 40%, #0e141f 0%, #0a0d13 65%);
    overflow: hidden;
  }

  #knowledge-explorer #explorer-svg {
    width: 100%;
    height: 100%;
    display: block;
  }

  /* ── Layer selector buttons ────────────────────── */
  #knowledge-explorer .explorer-layers {
    /* Hidden — layer buttons now live in Gradio right-pane header */
    display: none;
  }

  #knowledge-explorer .explorer-layer-btn {
    background: rgba(10, 13, 19, 0.85);
    border: 1px solid #1a1f2e;
    border-radius: 4px;
    padding: 3px 10px;
    cursor: pointer;
    color: #2e3648;
    font-size: 7px;
    font-weight: 600;
    font-family: inherit;
    letter-spacing: 0.8px;
    backdrop-filter: blur(8px);
    transition: all 0.2s;
  }

  #knowledge-explorer .explorer-layer-btn:hover {
    border-color: rgba(196, 92, 74, 0.3);
    color: #5a6580;
  }

  #knowledge-explorer .explorer-layer-btn.active {
    border-color: rgba(196, 92, 74, 0.5);
    color: #c45c4a;
    background: rgba(196, 92, 74, 0.06);
  }

  /* ── Chat highlight glow ─────────────────────── */
  @keyframes explorer-highlight-pulse {
    0%, 100% { filter: drop-shadow(0 0 3px var(--glow-color, #c45c4a)); }
    50% { filter: drop-shadow(0 0 10px var(--glow-color, #c45c4a)); }
  }

  #knowledge-explorer .node-highlighted .body {
    animation: explorer-highlight-pulse 2s ease-in-out infinite;
  }

  /* ── Detail panel ─────────────────────────────── */
  #knowledge-explorer .explorer-detail {
    position: absolute;
    top: 0;
    right: 0;
    width: 230px;
    height: 100%;
    background: #0e1219;
    border-left: 1px solid #1a1f2e;
    overflow-y: auto;
    display: flex;
    flex-direction: column;
    z-index: 20;
    transform: translateX(100%);
    transition: transform 300ms cubic-bezier(0.33, 0, 0.2, 1);
  }

  #knowledge-explorer .explorer-detail.explorer-detail-open {
    transform: translateX(0);
  }

  #knowledge-explorer .explorer-detail-close {
    position: absolute;
    top: 6px;
    right: 8px;
    background: none;
    border: none;
    color: #5a6580;
    font-size: 16px;
    cursor: pointer;
    padding: 2px 5px;
    line-height: 1;
    z-index: 2;
  }

  #knowledge-explorer .explorer-detail-close:hover {
    color: #c8d0e0;
  }

  /* Detail content styles */
  #knowledge-explorer .explorer-detail-header {
    padding: 12px 14px 10px;
    border-bottom: 1px solid #1a1f2e;
  }

  #knowledge-explorer .explorer-detail-type {
    display: flex;
    align-items: center;
    gap: 5px;
    margin-bottom: 5px;
  }

  #knowledge-explorer .explorer-detail-type-dot {
    width: 6px;
    height: 6px;
    border-radius: 50%;
    display: inline-block;
  }

  #knowledge-explorer .explorer-detail-type-label {
    font-size: 7px;
    font-weight: 600;
    letter-spacing: 1px;
  }

  #knowledge-explorer .explorer-detail-title {
    font-size: 12px;
    font-weight: 600;
    color: #c8d0e0;
    line-height: 1.35;
    margin: 0;
  }

  #knowledge-explorer .explorer-detail-sub {
    font-size: 8px;
    color: #5a6580;
    margin-top: 3px;
  }

  #knowledge-explorer .explorer-detail-body {
    padding: 10px 14px;
    flex: 1;
    display: flex;
    flex-direction: column;
    gap: 8px;
  }

  #knowledge-explorer .explorer-detail-field-label {
    font-size: 7px;
    color: #2e3648;
    letter-spacing: 0.8px;
    font-weight: 600;
    margin-bottom: 2px;
  }

  #knowledge-explorer .explorer-detail-field-value {
    font-size: 9px;
    color: #5a6580;
    line-height: 1.5;
  }

  #knowledge-explorer .explorer-detail-stat {
    display: inline-block;
    margin-right: 14px;
  }

  #knowledge-explorer .explorer-detail-stat-value {
    font-size: 18px;
    font-weight: 700;
  }

  #knowledge-explorer .explorer-detail-tag {
    display: inline-block;
    border-radius: 5px;
    padding: 2px 6px;
    font-size: 6.5px;
    margin: 1px;
    border: 1px solid;
  }

  #knowledge-explorer .explorer-detail-oa-badge {
    margin-left: auto;
    font-size: 6px;
    font-weight: 600;
    border-radius: 6px;
    padding: 1px 5px;
    letter-spacing: 0.3px;
    border: 1px solid;
  }

  #knowledge-explorer .explorer-detail-btn {
    width: 100%;
    background: transparent;
    border: 1px solid #1a1f2e;
    border-radius: 4px;
    padding: 5px 8px;
    cursor: pointer;
    color: #5a6580;
    font-size: 7px;
    font-weight: 600;
    font-family: inherit;
    letter-spacing: 0.5px;
    text-align: center;
    transition: all 0.2s;
  }

  #knowledge-explorer .explorer-detail-btn:hover {
    background: rgba(196, 92, 74, 0.07);
    border-color: rgba(196, 92, 74, 0.2);
    color: #c45c4a;
  }

  #knowledge-explorer .explorer-btn-loading {
    animation: explorer-pulse 1.2s infinite ease-in-out;
    border-color: rgba(196, 92, 74, 0.3);
    color: #c45c4a;
    pointer-events: none;
  }

  @keyframes explorer-pulse {
    0%, 100% { opacity: 0.5; }
    50% { opacity: 1; }
  }

  #knowledge-explorer .explorer-btn-success {
    border-color: rgba(34, 197, 94, 0.3);
    color: #22c55e;
  }

  #knowledge-explorer .explorer-detail-deselect {
    padding: 8px 14px;
    border-top: 1px solid #1a1f2e;
    flex-shrink: 0;
  }

  /* ── CTX toggle ────────────────────────────────── */
  #knowledge-explorer .explorer-ctx-toggle {
    background: transparent;
    border: 1px solid #1a1f2e;
    border-radius: 4px;
    color: #2e3648;
    padding: 3px 7px;
    cursor: pointer;
    font-size: 7px;
    font-weight: 600;
    font-family: inherit;
    letter-spacing: 0.5px;
    transition: all 0.2s;
    margin-left: 4px;
    flex-shrink: 0;
  }
  #knowledge-explorer .explorer-ctx-toggle.active {
    border-color: rgba(46, 90, 136, 0.4);
    color: #2e5a88;
    background: rgba(46, 90, 136, 0.05);
  }
  #knowledge-explorer .explorer-ctx-toggle:hover {
    border-color: rgba(46, 90, 136, 0.5);
    color: #2e5a88;
  }
</style>

<script src="https://d3js.org/d3.v7.min.js"></script>
<script>
(function() {
  "use strict";

  var data = {= graph_json =};
  if (!data || !data.nodes || !data.nodes.length) return;

  var container = document.getElementById("knowledge-explorer");
  var canvasEl = container.querySelector(".explorer-canvas");
  var svg = d3.select("#explorer-svg");
  var width = canvasEl.clientWidth || 600;
  var height = canvasEl.clientHeight || 500;

  svg.attr("viewBox", [0, 0, width, height]);

  // ── OA config ─────────────────────────────────────
  var OA = {
    gold:     { color: "#22c55e", label: "GOLD OA",     dash: null },
    green:    { color: "#16a34a", label: "GREEN OA",    dash: null },
    hybrid:   { color: "#65a30d", label: "HYBRID OA",   dash: null },
    bronze:   { color: "#d97706", label: "BRONZE OA",   dash: null },
    open:     { color: "#22c55e", label: "OPEN ACCESS",  dash: null },
    preprint: { color: "#eab308", label: "PREPRINT",    dash: null },
    closed:   { color: "#64748b", label: "PAYWALLED",   dash: "2,2" }
  };

  // ── Build node lookup & derive paper colors from authorship ──
  var nodeMap = {};
  data.nodes.forEach(function(n) { nodeMap[n.id] = n; });

  // Pre-compute paper -> researcher color via authorship edges
  data.links.forEach(function(l) {
    if (l.type === "authorship") {
      var tid = l.target.id !== undefined ? l.target.id : l.target;
      var sid = l.source.id !== undefined ? l.source.id : l.source;
      var tNode = nodeMap[tid];
      var sNode = nodeMap[sid];
      if (tNode && sNode && tNode.type === "paper") {
        tNode._authorColor = sNode.color;
      }
    }
  });

  // ── Edge style ────────────────────────────────────
  function edgeStyle(d) {
    if (d.type === "authorship") {
      var src = nodeMap[d.source.id || d.source];
      return { stroke: src ? src.color : "#5a6580", dash: null, width: 1, opacity: 0.12 };
    }
    if (d.type === "citation") {
      return { stroke: "#475569", dash: "3,3", width: 0.8, opacity: 0.1 };
    }
    if (d.type === "semantic") {
      var score = (d.metadata && d.metadata.score) || 0.5;
      return { stroke: "#c45c4a", dash: "5,3", width: 0.8 + score * 2, opacity: 0.1 + score * 0.35 };
    }
    if (d.type === "field_membership") {
      return { stroke: "#2e5a88", dash: "2,3", width: 0.5, opacity: 0.06 };
    }
    if (d.type === "domain_mapping") {
      return { stroke: "#555", dash: "3,5", width: 0.4, opacity: 0.04 };
    }
    return { stroke: "#333", dash: null, width: 0.8, opacity: 0.08 };
  }

  // ── Defs: gradients + glow filter ─────────────────
  var defs = svg.append("defs");
  data.nodes.forEach(function(n) {
    var c = n.type === "paper" ? (n._authorColor || n.color) : n.color;
    var gr = defs.append("radialGradient").attr("id", "ng-" + n.id.replace(/[^a-zA-Z0-9]/g, "_")).attr("cx", "35%").attr("cy", "35%");
    gr.append("stop").attr("offset", "0%").attr("stop-color", c).attr("stop-opacity", 0.28);
    gr.append("stop").attr("offset", "100%").attr("stop-color", c).attr("stop-opacity", 0.04);
  });
  var glow = defs.append("filter").attr("id", "glow").attr("x", "-50%").attr("y", "-50%").attr("width", "200%").attr("height", "200%");
  glow.append("feGaussianBlur").attr("stdDeviation", "4").attr("result", "b");
  var gm = glow.append("feMerge");
  gm.append("feMergeNode").attr("in", "b");
  gm.append("feMergeNode").attr("in", "SourceGraphic");

  // ── Root group + zoom ─────────────────────────────
  var root = svg.append("g");
  svg.call(d3.zoom().scaleExtent([0.35, 2.5]).on("zoom", function(e) { root.attr("transform", e.transform); }));

  // ── Ambient halos ─────────────────────────────────
  var haloNodes = data.nodes.filter(function(n) { return n.type !== "paper" && n.type !== "field"; });
  var haloSelection = root.append("g").attr("class", "explorer-halos").selectAll("circle")
    .data(haloNodes)
    .join("circle")
    .attr("r", function(d) { return d.type === "domain" ? d.size * 4 : d.size * 2.2; })
    .attr("fill", function(d) { return d.color; })
    .attr("opacity", function(d) { return d.type === "domain" ? 0.008 : 0.015; });

  // ── Links ─────────────────────────────────────────
  var linkG = root.append("g");
  var link = linkG.selectAll("line").data(data.links).join("line")
    .each(function(d) {
      var s = edgeStyle(d);
      d3.select(this).attr("stroke", s.stroke).attr("stroke-width", s.width).attr("opacity", s.opacity);
      if (s.dash) d3.select(this).attr("stroke-dasharray", s.dash);
    });

  // Score labels on semantic edges
  var scoreLabels = linkG.selectAll("text")
    .data(data.links.filter(function(l) { return l.type === "semantic" && l.metadata && l.metadata.score > 0.3; }))
    .join("text")
    .text(function(d) { return Math.round(d.metadata.score * 100) + "%"; })
    .attr("font-size", "7px").attr("fill", "#c45c4a").attr("opacity", 0)
    .attr("text-anchor", "middle").attr("font-family", "inherit")
    .style("pointer-events", "none");

  // ── Nodes ─────────────────────────────────────────
  var nodeG = root.append("g");
  var node = nodeG.selectAll("g").data(data.nodes).join("g").style("cursor", "pointer");

  // Append all visual elements (OA rings, outer rings, body, icons, labels, sub-labels, field tags)
  setupNodeVisuals(node);

  // ── Drag ──────────────────────────────────────────
  node.call(d3.drag()
    .on("start", function(ev, d) { d.fx = d.x; d.fy = d.y; })
    .on("drag", function(ev, d) {
      d.fx = ev.x; d.fy = ev.y;
      simulation.alphaTarget(0.02).restart();
    })
    .on("end", function(ev, d) {
      d.fx = null; d.fy = null;
      simulation.alphaTarget(0);
    })
  );

  // ── Hover (no simulation restart) ─────────────────
  var selectedNode = null;

  node.on("mouseenter", function(ev, d) {
    if (selectedNode) return;
    var conn = getConnected(d.id);

    node.transition().duration(250).ease(d3.easeCubicOut)
      .attr("opacity", function(n) { return conn.has(n.id) ? 1 : 0.15; });
    node.selectAll(".body").transition().duration(250).ease(d3.easeCubicOut)
      .attr("r", function(n) { return n.id === d.id ? n.size + 3 : n.size; });
    node.selectAll(".sub-label").transition().duration(250)
      .attr("opacity", function(n) { return n.id === d.id ? 0.7 : 0; });
    node.selectAll(".field-tag").transition().duration(250)
      .attr("opacity", function(n) { return conn.has(n.id) ? 0.5 : 0; });

    link.transition().duration(250).ease(d3.easeCubicOut)
      .attr("opacity", function(l) { return isConnectedLink(l, d.id) ? 0.6 : 0.03; })
      .attr("stroke-width", function(l) {
        if (!isConnectedLink(l, d.id)) return edgeStyle(l).width;
        return l.type === "semantic" ? 1.5 + ((l.metadata && l.metadata.score) || 0) * 3 : 2;
      });

    scoreLabels.transition().duration(250)
      .attr("opacity", function(l) { return isConnectedLink(l, d.id) ? 0.7 : 0; });
  });

  node.on("mouseleave", function(ev, d) {
    if (selectedNode) return;
    resetVisuals();
  });

  // ── Click / Selection ─────────────────────────────
  var detailEl = document.getElementById("explorer-detail");

  node.on("click", function(ev, d) {
    ev.stopPropagation();
    if (selectedNode && selectedNode.id === d.id) {
      selectedNode = null;
      resetVisuals();
      detailEl.classList.remove("explorer-detail-open");
      // Clear context on deselect
      parent.postMessage({type: "explorer-select", nodeType: null, nodeId: null, label: null}, "*");
      return;
    }
    selectedNode = d;
    applySelection(d);
    showDetail(d);
    // Notify parent of context selection (researcher or paper)
    if (d.type === "researcher" || d.type === "paper") {
      parent.postMessage({type: "explorer-select", nodeType: d.type, nodeId: d.id, label: d.label}, "*");
    }
  });

  svg.on("click", function() {
    selectedNode = null;
    resetVisuals();
    detailEl.classList.remove("explorer-detail-open");
  });

  // ── Visual helpers ────────────────────────────────
  function getConnected(nodeId) {
    var ids = new Set([nodeId]);
    data.links.forEach(function(l) {
      var s = l.source.id !== undefined ? l.source.id : l.source;
      var t = l.target.id !== undefined ? l.target.id : l.target;
      if (s === nodeId) ids.add(t);
      if (t === nodeId) ids.add(s);
    });
    return ids;
  }

  function isConnectedLink(l, nodeId) {
    var s = l.source.id !== undefined ? l.source.id : l.source;
    var t = l.target.id !== undefined ? l.target.id : l.target;
    return s === nodeId || t === nodeId;
  }

  function resetVisuals() {
    node.transition().duration(350).ease(d3.easeCubicOut).attr("opacity", 1);
    node.selectAll(".body").transition().duration(350).ease(d3.easeCubicOut)
      .attr("r", function(d) { return d.size; });
    node.selectAll(".sub-label").transition().duration(250).attr("opacity", 0);
    node.selectAll(".field-tag").transition().duration(250).attr("opacity", 0);
    link.transition().duration(350).ease(d3.easeCubicOut)
      .each(function(l) {
        var s = edgeStyle(l);
        d3.select(this).attr("opacity", s.opacity).attr("stroke-width", s.width);
      });
    scoreLabels.transition().duration(250).attr("opacity", 0);
  }

  function applySelection(d) {
    var conn = getConnected(d.id);
    node.transition().duration(300).ease(d3.easeCubicOut)
      .attr("opacity", function(n) { return conn.has(n.id) ? 1 : 0.1; });
    node.selectAll(".body").transition().duration(300).ease(d3.easeCubicOut)
      .attr("r", function(n) { return n.id === d.id ? n.size + 4 : n.size; });
    node.selectAll(".sub-label").transition().duration(300)
      .attr("opacity", function(n) { return conn.has(n.id) ? 0.7 : 0; });
    node.selectAll(".field-tag").transition().duration(300)
      .attr("opacity", function(n) { return conn.has(n.id) ? 0.55 : 0; });

    link.transition().duration(300).ease(d3.easeCubicOut)
      .attr("opacity", function(l) { return isConnectedLink(l, d.id) ? 0.65 : 0.02; })
      .attr("stroke-width", function(l) {
        if (!isConnectedLink(l, d.id)) return l.type === "citation" ? 0.8 : 1;
        return l.type === "semantic" ? 2 + ((l.metadata && l.metadata.score) || 0) * 3 : 2.5;
      });

    scoreLabels.transition().duration(300)
      .attr("opacity", function(l) { return isConnectedLink(l, d.id) ? 0.8 : 0; });
  }

  // ── Detail panel ──────────────────────────────────
  function showDetail(d) {
    var m = d.metadata || {};
    var c = d._authorColor || d.color;
    var oa = (m.oa_status && OA[m.oa_status]) || null;
    var html = '';

    // Header
    html += '<div class="explorer-detail-header">';
    html += '<div class="explorer-detail-type">';
    html += '<span class="explorer-detail-type-dot" style="background:' + c + ';opacity:0.7"></span>';
    html += '<span class="explorer-detail-type-label" style="color:' + c + '">' + d.type.toUpperCase() + '</span>';
    if (oa) {
      html += '<span class="explorer-detail-oa-badge" style="color:' + oa.color + ';background:' + oa.color + '10;border-color:' + oa.color + '25">' + oa.label + '</span>';
    }
    html += '</div>';
    html += '<div class="explorer-detail-title">' + esc(d.label) + '</div>';
    // Sub-line
    if (d.type === "paper") html += '<div class="explorer-detail-sub">' + (m.year || "") + " \u00B7 " + ((m.citations || 0) + " citations") + '</div>';
    if (d.type === "researcher") html += '<div class="explorer-detail-sub">h-index: ' + (m.h_index || "?") + " \u00B7 " + ((m.affiliations && m.affiliations[0]) || "") + '</div>';
    html += '</div>';

    // Body
    html += '<div class="explorer-detail-body">';

    if (d.type === "researcher") {
      html += '<div>';
      html += '<span class="explorer-detail-stat"><div class="explorer-detail-field-label">H-INDEX</div><div class="explorer-detail-stat-value" style="color:' + c + '">' + (m.h_index || "?") + '</div></span>';
      html += '<span class="explorer-detail-stat"><div class="explorer-detail-field-label">WORKS</div><div class="explorer-detail-stat-value" style="color:' + c + '">' + (m.works_count || "?") + '</div></span>';
      html += '</div>';
      if (m.fields && m.fields.length) {
        html += '<div>';
        m.fields.forEach(function(f) {
          html += '<span class="explorer-detail-tag" style="color:' + c + ';background:' + c + '0c;border-color:' + c + '18">' + esc(f) + '</span> ';
        });
        html += '</div>';
      }
      html += '<div style="display:flex;flex-direction:column;gap:3px;margin-top:4px">';
      var primaryLabel = activeLayer === "topics" ? "DISCOVER RELATED" : "LOAD ALL PAPERS";
      var primaryAction = activeLayer === "topics" ? "discover-related" : "load-papers";
      html += '<button class="explorer-detail-btn explorer-action-btn" data-action="' + primaryAction + '" data-node-id="' + esc(d.id) + '" data-researcher-name="' + esc(d.label) + '" style="color:' + c + '">' + primaryLabel + '</button>';
      html += '<button class="explorer-detail-btn">CO-AUTHOR NETWORK</button>';
      html += '<button class="explorer-detail-btn">VIEW PROFILE \u2192</button>';
      html += '</div>';
    }

    if (d.type === "paper") {
      if (m.fields && m.fields.length) {
        html += '<div>';
        m.fields.forEach(function(f) {
          html += '<span class="explorer-detail-tag" style="color:' + c + ';background:' + c + '0c;border-color:' + c + '18">' + esc(f) + '</span> ';
        });
        html += '</div>';
      }
      if (m.tldr || m.abstract) {
        var summaryLabel = m.tldr ? "TLDR" : "ABSTRACT";
        var summaryText = m.tldr || m.abstract;
        html += '<div><div class="explorer-detail-field-label">' + summaryLabel + '</div><div class="explorer-detail-field-value">' + esc(summaryText) + '</div></div>';
      }
      if (m.doi) {
        html += '<div><div class="explorer-detail-field-label">DOI</div><div style="font-size:7px;color:#5a7eaa;word-break:break-all">' + esc(m.doi) + '</div></div>';
      }
      html += '<div style="display:flex;flex-direction:column;gap:3px;margin-top:4px">';
      var oaCfg = OA[m.oa_status] || OA.closed;
      if (m.oa_status === "gold" || m.oa_status === "green" || m.oa_status === "hybrid" || m.oa_status === "open") html += '<button class="explorer-detail-btn" style="color:' + oaCfg.color + '">\u2193 DOWNLOAD PDF</button>';
      else if (m.oa_status === "bronze") html += '<button class="explorer-detail-btn" style="color:#d97706">\u2193 VIEW (BRONZE OA)</button>';
      else if (m.oa_status === "preprint") html += '<button class="explorer-detail-btn" style="color:#eab308">\u2193 GET PREPRINT</button>';
      else html += '<div style="font-size:7px;color:#5a6580;text-align:center;padding:5px;background:rgba(255,255,255,0.01);border-radius:4px;border:1px solid #1a1f2e">\uD83D\uDD12 Abstract + metadata only</div>';
      html += '<button class="explorer-detail-btn explorer-action-btn" data-action="expand-citations" data-node-id="' + esc(d.id) + '" data-paper-title="' + esc(d.label) + '">EXPAND CITATIONS \u2192</button>';
      html += '<button class="explorer-detail-btn explorer-action-btn" data-action="find-similar" data-node-id="' + esc(d.id) + '" data-paper-title="' + esc(d.label) + '">FIND SIMILAR PAPERS</button>';
      html += '</div>';
    }

    if (d.type === "query") {
      html += '<div class="explorer-detail-field-value">Dashed edges show semantic similarity. Percentage = cosine similarity score.</div>';
    }

    if (d.type === "field") {
      var fConn = getConnected(d.id);
      var fPapers = 0, fResearchers = 0, fDomains = [];
      fConn.forEach(function(cid) {
        var cn = nodeMap[cid];
        if (cn && cn.type === "paper") fPapers++;
        if (cn && cn.type === "researcher") fResearchers++;
        if (cn && cn.type === "domain") fDomains.push(cn.label);
      });
      html += '<div><div class="explorer-detail-field-label">CONNECTIONS</div>';
      html += '<div class="explorer-detail-field-value">' + fPapers + ' papers, ' + fResearchers + ' researchers</div></div>';
      if (fDomains.length) {
        html += '<div><div class="explorer-detail-field-label">DOMAIN</div>';
        fDomains.forEach(function(dl) {
          html += '<span class="explorer-detail-tag" style="color:' + c + ';background:' + c + '0c;border-color:' + c + '18">' + esc(dl) + '</span> ';
        });
        html += '</div>';
      }
    }

    if (d.type === "domain") {
      var dConn = getConnected(d.id);
      var dFields = [];
      dConn.forEach(function(cid) {
        var cn = nodeMap[cid];
        if (cn && cn.type === "field") dFields.push(cn.label);
      });
      if (dFields.length) {
        html += '<div><div class="explorer-detail-field-label">FIELDS IN THIS DOMAIN</div>';
        dFields.forEach(function(fl) {
          html += '<span class="explorer-detail-tag" style="color:' + c + ';background:' + c + '0c;border-color:' + c + '18">' + esc(fl) + '</span> ';
        });
        html += '</div>';
      }
      html += '<div class="explorer-detail-field-value" style="margin-top:6px">Structural scaffold node representing a broad societal domain.</div>';
    }

    html += '</div>';

    // Deselect button
    html += '<div class="explorer-detail-deselect"><button class="explorer-detail-btn" onclick="document.getElementById(\'explorer-detail\').classList.remove(\'explorer-detail-open\')">DESELECT</button></div>';

    detailEl.querySelector(".explorer-detail-content").innerHTML = html;
    detailEl.classList.add("explorer-detail-open");
  }

  function esc(str) {
    var d = document.createElement("div");
    d.textContent = str;
    return d.innerHTML;
  }

  // Close button
  detailEl.querySelector(".explorer-detail-close").addEventListener("click", function(e) {
    e.stopPropagation();
    selectedNode = null;
    resetVisuals();
    detailEl.classList.remove("explorer-detail-open");
  });

  // ── Action button delegation (detail panel → parent → Python) ───
  var _actionTimeout = null;

  function _resetActionBtn() {
    clearTimeout(_actionTimeout);
    _actionTimeout = null;
    var btn = detailEl.querySelector(".explorer-btn-loading");
    if (btn) {
      btn.classList.remove("explorer-btn-loading");
      btn.textContent = btn._originalLabel || "LOAD ALL PAPERS";
    }
  }

  detailEl.addEventListener("click", function(ev) {
    var btn = ev.target.closest(".explorer-action-btn");
    if (!btn || btn.classList.contains("explorer-btn-loading")) return;

    var action = btn.getAttribute("data-action");
    var nodeId = btn.getAttribute("data-node-id");
    if (!action || !nodeId) return;

    // Set loading state
    btn._originalLabel = btn.textContent;
    btn.textContent = "LOADING\u2026";
    btn.classList.add("explorer-btn-loading");

    // Safety timeout — unlock after 25s if no response
    clearTimeout(_actionTimeout);
    _actionTimeout = setTimeout(function() {
      _resetActionBtn();
    }, 25000);

    // Send action to parent frame
    parent.postMessage({
      type: "explorer-action",
      payload: {
        action: action,
        nodeId: nodeId,
        researcherName: btn.getAttribute("data-researcher-name") || "",
        paperTitle: btn.getAttribute("data-paper-title") || "",
        layer: activeLayer,
      }
    }, "*");
  });

  // ── Search ────────────────────────────────────────
  var searchInput = container.querySelector(".explorer-search");
  var searchBtn = container.querySelector(".explorer-search-btn");

  function doSearch() {
    var q = searchInput.value.trim().toLowerCase();
    if (!q) {
      node.transition().duration(300).attr("opacity", 1);
      link.each(function(l) { var s = edgeStyle(l); d3.select(this).transition().duration(300).attr("opacity", s.opacity); });
      return;
    }
    node.transition().duration(300).attr("opacity", function(d) {
      return d.label.toLowerCase().indexOf(q) !== -1 ? 1 : 0.08;
    });
    link.transition().duration(300).attr("opacity", function(l) {
      var s = l.source.id !== undefined ? l.source.id : l.source;
      var t = l.target.id !== undefined ? l.target.id : l.target;
      var sm = nodeMap[s] && nodeMap[s].label.toLowerCase().indexOf(q) !== -1;
      var tm = nodeMap[t] && nodeMap[t].label.toLowerCase().indexOf(q) !== -1;
      return (sm || tm) ? edgeStyle(l).opacity * 2 : 0.02;
    });
  }

  searchBtn.addEventListener("click", doSearch);
  searchInput.addEventListener("keydown", function(e) { if (e.key === "Enter") doSearch(); });

  // ── Layer emphasis system ───────────────────────────
  var layersEl = document.getElementById("explorer-layers");
  var layerBtns = layersEl.querySelectorAll(".explorer-layer-btn");
  var headerLayerBtns = document.querySelectorAll(".elb[data-layer]");
  var activeLayer = data.active_layer || "structure";

  function setActiveLayerBtn(layer) {
    layerBtns.forEach(function(b) { b.classList.remove("active"); });
    layerBtns.forEach(function(b) {
      if (b.getAttribute("data-layer") === layer) b.classList.add("active");
    });
    // Also update header buttons
    headerLayerBtns.forEach(function(b) { b.classList.remove("active"); });
    headerLayerBtns.forEach(function(b) {
      if (b.getAttribute("data-layer") === layer) b.classList.add("active");
    });
  }

  /* Called by header layer buttons */
  function switchLayerBtn(btn, layer) {
    setActiveLayerBtn(layer);
    applyLayerEmphasis(layer);
    /* Notify parent Gradio of layer change */
    window.parent.postMessage({type: "explorer-layer", layer: layer}, "*");
  }

  function applyLayerEmphasis(layer) {
    activeLayer = layer;
    var ht = data.highlight_terms || [];

    // Pre-compute disabled labels per layer
    var ci = (data.context_items) || {};
    var socDisabled = (ci.soc_items || ci.soc || []).filter(function(it) { return it.enabled === false; })
                       .map(function(it) { return it.label.toLowerCase(); });
    var authDisabled = (ci.auth_items || ci.auth || []).filter(function(it) { return it.enabled === false; })
                        .map(function(it) { return it.label.toLowerCase(); });
    var chatEnabled = (ci.chat_items || ci.chat || []).filter(function(it) { return it.enabled !== false; })
                       .map(function(it) { return it.label.toLowerCase(); });

    // Node emphasis
    node.transition().duration(400).attr("opacity", function(d) {
      if (layer === "structure") {
        if (d.type === "domain" || d.type === "field") {
          var lbl = d.label.toLowerCase();
          if (socDisabled.some(function(dl) { return lbl === dl; })) return 0.03;
        }
        if (d.type === "domain") return 0.9;
        if (d.type === "field") return 1;
        if (d.type === "researcher") return 0.15;
        if (d.type === "paper") return 0.1;
        if (d.type === "query") return 0.2;
        return 0.2;
      } else if (layer === "people") {
        var ai = (ci.auth_items || ci.auth || []);
        var authLabels = ai.filter(function(it) { return it.enabled !== false; })
                           .map(function(it) { return (it.label || it).toLowerCase(); });
        if (d.type === "researcher") {
          var rLbl = d.label.toLowerCase();
          if (authDisabled.some(function(dl) { return rLbl === dl; })) return 0.1;
          return 1;
        }
        if (d.type === "paper") {
          // Dim papers if their researcher is disabled
          if (d._authorColor) {
            var authorNode = data.nodes.find(function(n) { return n.type === "researcher"; });
            if (authorNode && authDisabled.some(function(dl) { return authorNode.label.toLowerCase() === dl; })) return 0.1;
          }
          return 1;
        }
        if (authLabels.length > 0) {
          var lbl = d.label.toLowerCase();
          if (authLabels.some(function(t) { return lbl.indexOf(t) !== -1; })) return 1;
        }
        if (d.type === "query") return 0.8;
        if (d.type === "field") return 0.2;
        if (d.type === "domain") return 0.1;
        return 0.5;
      } else if (layer === "topics") {
        var label = d.label.toLowerCase();
        // Use enabled chat items if context exists, else fall back to highlight_terms
        var chatItems = ci.chat_items || ci.chat || [];
        var hasCtxChat = chatItems.length > 0;
        var terms = hasCtxChat ? chatEnabled : ht.map(function(t) { return t.toLowerCase(); });
        var matched = terms.length > 0 && terms.some(function(t) {
          return label.indexOf(t) !== -1;
        });
        if (matched) return 1;
        if (d.type === "researcher") return 0.6;
        if (d.type === "paper") return 0.2;
        return 0.1;
      }
      return 1;
    });

    // Edge emphasis
    link.transition().duration(400).attr("opacity", function(l) {
      var base = edgeStyle(l).opacity;
      if (layer === "structure") {
        if (l.type === "field_membership" || l.type === "domain_mapping") return Math.min(base * 3, 0.8);
        return base * 0.1;
      } else if (layer === "people") {
        if (l.type === "authorship" || l.type === "citation" || l.type === "semantic") return Math.min(base * 2, 0.8);
        return base * 0.2;
      } else if (layer === "topics") {
        return base * 0.5;
      }
      return base;
    });

    // Domain halos
    root.select(".explorer-halos").selectAll("circle")
      .filter(function(d) { return d.type === "domain"; })
      .transition().duration(400)
      .attr("opacity", layer === "structure" ? 0.04 : 0.003);

    // Highlight glow per layer
    node.each(function(d) {
      var el = d3.select(this);
      var highlighted = false;
      var glowColor = d._authorColor || d.color || "#c45c4a";

      if (layer === "structure") {
        // Structure: highlight fields and domains (skip disabled)
        if (d.type === "domain" || d.type === "field") {
          var sLbl = d.label.toLowerCase();
          if (!socDisabled.some(function(dl) { return sLbl === dl; })) {
            highlighted = true;
            glowColor = d.color || "#2e5a88";
          }
        }
      } else if (layer === "people") {
        // People: highlight researcher, papers, and pinned items (skip disabled)
        if (d.type === "researcher") {
          var rLbl = d.label.toLowerCase();
          highlighted = !authDisabled.some(function(dl) { return rLbl === dl; });
        } else if (d.type === "paper") {
          var authorNode = data.nodes.find(function(n) { return n.type === "researcher"; });
          if (authorNode && authDisabled.some(function(dl) { return authorNode.label.toLowerCase() === dl; })) {
            highlighted = false;
          } else {
            highlighted = true;
          }
        } else {
          var ai2 = (ci.auth_items || ci.auth || []).filter(function(it) { return it.enabled !== false; });
          var lbl2 = d.label.toLowerCase();
          if (ai2.some(function(it) { return lbl2.indexOf((it.label || it).toLowerCase()) !== -1; })) {
            highlighted = true;
          }
        }
      } else if (layer === "topics") {
        // Topics: highlight keyword-matched nodes (only enabled terms)
        var chatItems2 = ci.chat_items || ci.chat || [];
        var hasCtxChat2 = chatItems2.length > 0;
        var terms2 = hasCtxChat2 ? chatEnabled : ht.map(function(t) { return t.toLowerCase(); });
        if (terms2.length > 0) {
          var label = d.label.toLowerCase();
          highlighted = terms2.some(function(t) { return label.indexOf(t) !== -1; });
        }
      }

      el.classed("node-highlighted", highlighted);
      if (highlighted) el.style("--glow-color", glowColor);
      // Boost body opacity for highlighted structural nodes so glow is visible
      el.select(".body").transition().duration(400)
        .attr("opacity", highlighted ? 0.85 : (d.type === "domain" ? 0.25 : d.type === "field" ? 0.5 : 0.9));
    });

    // Update action button labels in open detail panel
    var actionBtn = detailEl.querySelector(".explorer-action-btn");
    if (actionBtn && !actionBtn.classList.contains("explorer-btn-loading")) {
      if (actionBtn.getAttribute("data-researcher-name")) {
        actionBtn.textContent = layer === "topics" ? "DISCOVER RELATED" : "LOAD ALL PAPERS";
        actionBtn.setAttribute("data-action", layer === "topics" ? "discover-related" : "load-papers");
      }
    }
  }

  // Set initial button state
  setActiveLayerBtn(activeLayer);

  // Header button clicks
  headerLayerBtns.forEach(function(btn) {
    btn.addEventListener("click", function() {
      var layer = btn.getAttribute("data-layer");
      setActiveLayerBtn(layer);
      applyLayerEmphasis(layer);
      window.parent.postMessage({type: "explorer-layer", layer: layer}, "*");
    });
  });

  // Bottom button clicks
  layerBtns.forEach(function(btn) {
    btn.addEventListener("click", function() {
      var layer = btn.getAttribute("data-layer");
      setActiveLayerBtn(layer);
      applyLayerEmphasis(layer);
      parent.postMessage({type: "explorer-layer", layer: layer}, "*");
    });
  });

  // Listen for layer changes from parent (top-bar buttons)
  window.addEventListener("message", function(e) {
    if (e.data && e.data.type === "set-layer") {
      setActiveLayerBtn(e.data.layer);
      applyLayerEmphasis(e.data.layer);
    }
    if (e.data && e.data.type === "set-highlights") {
      data.highlight_terms = e.data.terms;
      if (activeLayer === "topics") applyLayerEmphasis("topics");
    }
    if (e.data && e.data.type === "set-context-items") {
      data.context_items = e.data.items;
      applyLayerEmphasis(activeLayer);
    }
    if (e.data && e.data.type === "update-graph" && e.data.delta) {
      rebindGraph(e.data.delta);
    }
    if (e.data && e.data.type === "action-result") {
      var result = e.data.result || {};
      clearTimeout(_actionTimeout);
      _actionTimeout = null;
      var loadingBtn = detailEl.querySelector(".explorer-btn-loading");
      if (loadingBtn) {
        loadingBtn.classList.remove("explorer-btn-loading");
        if (result.success) {
          var count = (result.delta && result.delta.addNodes)
            ? result.delta.addNodes.filter(function(n) { return n.type === "paper"; }).length
            : 0;
          loadingBtn.textContent = "\u2713 " + count + " PAPERS ADDED";
          loadingBtn.classList.add("explorer-btn-success");
          setTimeout(function() {
            loadingBtn.classList.remove("explorer-btn-success");
            loadingBtn.textContent = loadingBtn._originalLabel || "LOAD ALL PAPERS";
          }, 2500);
        } else {
          loadingBtn.textContent = result.error ? result.error.substring(0, 30) : "FAILED";
          setTimeout(function() {
            loadingBtn.textContent = loadingBtn._originalLabel || "LOAD ALL PAPERS";
          }, 3000);
        }
      }
      if (result.delta) {
        rebindGraph(result.delta);
      }
    }
  });

  // ── Incremental graph update (enter/update/exit) ──────
  function rebindGraph(delta) {
    var addNodes = delta.addNodes || [];
    var removeIds = new Set(delta.removeNodes || []);
    var addLinks = delta.addLinks || [];
    var removeLinks = delta.removeLinks || [];

    // Remove nodes
    if (removeIds.size > 0) {
      data.nodes = data.nodes.filter(function(n) { return !removeIds.has(n.id); });
      removeIds.forEach(function(id) { delete nodeMap[id]; });
    }

    // Remove links
    if (removeLinks.length > 0) {
      var rlSet = new Set(removeLinks.map(function(l) { return l.source + "|" + l.target + "|" + l.type; }));
      data.links = data.links.filter(function(l) {
        var s = l.source.id !== undefined ? l.source.id : l.source;
        var t = l.target.id !== undefined ? l.target.id : l.target;
        return !rlSet.has(s + "|" + t + "|" + (l.type || ""));
      });
    }

    // Add nodes
    addNodes.forEach(function(n) {
      n.x = width / 2 + (Math.random() - 0.5) * 100;
      n.y = height / 2 + (Math.random() - 0.5) * 100;
      data.nodes.push(n);
      nodeMap[n.id] = n;
    });

    // Pre-compute paper colors for new authorship edges
    addLinks.forEach(function(l) {
      if (l.type === "authorship") {
        var tid = l.target.id !== undefined ? l.target.id : l.target;
        var sid = l.source.id !== undefined ? l.source.id : l.source;
        var tNode = nodeMap[tid];
        var sNode = nodeMap[sid];
        if (tNode && sNode && tNode.type === "paper") tNode._authorColor = sNode.color;
      }
    });

    // Add links
    addLinks.forEach(function(l) { data.links.push(l); });

    // Create gradients for new nodes
    addNodes.forEach(function(n) {
      var c = n.type === "paper" ? (n._authorColor || n.color) : n.color;
      var gr = defs.append("radialGradient").attr("id", "ng-" + n.id.replace(/[^a-zA-Z0-9]/g, "_")).attr("cx", "35%").attr("cy", "35%");
      gr.append("stop").attr("offset", "0%").attr("stop-color", c).attr("stop-opacity", 0.28);
      gr.append("stop").attr("offset", "100%").attr("stop-color", c).attr("stop-opacity", 0.04);
    });

    // Rebind links
    link = linkG.selectAll("line").data(data.links, function(d) {
      var s = d.source.id !== undefined ? d.source.id : d.source;
      var t = d.target.id !== undefined ? d.target.id : d.target;
      return s + "|" + t + "|" + (d.type || "");
    });
    link.exit().remove();
    var linkEnter = link.enter().append("line").each(function(d) {
      var s = edgeStyle(d);
      d3.select(this).attr("stroke", s.stroke).attr("stroke-width", s.width).attr("opacity", 0);
      if (s.dash) d3.select(this).attr("stroke-dasharray", s.dash);
    });
    linkEnter.transition().duration(500).attr("opacity", function(d) { return edgeStyle(d).opacity; });
    link = linkEnter.merge(link);

    // Rebind score labels
    scoreLabels = linkG.selectAll("text")
      .data(data.links.filter(function(l) { return l.type === "semantic" && l.metadata && l.metadata.score > 0.3; }))
      .join("text")
      .text(function(d) { return Math.round(d.metadata.score * 100) + "%"; })
      .attr("font-size", "7px").attr("fill", "#c45c4a").attr("opacity", 0)
      .attr("text-anchor", "middle").attr("font-family", "inherit")
      .style("pointer-events", "none");

    // Rebind nodes
    node = nodeG.selectAll("g").data(data.nodes, function(d) { return d.id; });
    node.exit().transition().duration(300).attr("opacity", 0).remove();
    var nodeEnter = node.enter().append("g").style("cursor", "pointer").attr("opacity", 0);
    setupNodeVisuals(nodeEnter);
    nodeEnter.transition().duration(500).attr("opacity", 1);

    // Re-apply drag + events to entering nodes
    nodeEnter.call(d3.drag()
      .on("start", function(ev, d) { d.fx = d.x; d.fy = d.y; })
      .on("drag", function(ev, d) { d.fx = ev.x; d.fy = ev.y; simulation.alphaTarget(0.02).restart(); })
      .on("end", function(ev, d) { d.fx = null; d.fy = null; simulation.alphaTarget(0); })
    );
    nodeEnter.on("mouseenter", function(ev, d) {
      if (selectedNode) return;
      var conn = getConnected(d.id);
      node.transition().duration(250).ease(d3.easeCubicOut)
        .attr("opacity", function(n) { return conn.has(n.id) ? 1 : 0.15; });
      link.transition().duration(250).ease(d3.easeCubicOut)
        .attr("opacity", function(l) { return isConnectedLink(l, d.id) ? 0.6 : 0.03; });
    });
    nodeEnter.on("mouseleave", function() { if (!selectedNode) resetVisuals(); });
    nodeEnter.on("click", function(ev, d) {
      ev.stopPropagation();
      if (selectedNode && selectedNode.id === d.id) {
        selectedNode = null; resetVisuals(); detailEl.classList.remove("explorer-detail-open");
        parent.postMessage({type: "explorer-select", nodeType: null, nodeId: null, label: null}, "*");
        return;
      }
      selectedNode = d; applySelection(d); showDetail(d);
      if (d.type === "researcher" || d.type === "paper") {
        parent.postMessage({type: "explorer-select", nodeType: d.type, nodeId: d.id, label: d.label}, "*");
      }
    });

    node = nodeEnter.merge(node);

    // Rebind halos
    var haloNodes2 = data.nodes.filter(function(n) { return n.type !== "paper" && n.type !== "field"; });
    haloSelection = root.select(".explorer-halos").selectAll("circle").data(haloNodes2, function(d) { return d.id; });
    haloSelection.exit().remove();
    var haloEnter = haloSelection.enter().append("circle")
      .attr("r", function(d) { return d.type === "domain" ? d.size * 4 : d.size * 2.2; })
      .attr("fill", function(d) { return d.color; })
      .attr("opacity", function(d) { return d.type === "domain" ? 0.008 : 0.015; });
    haloSelection = haloEnter.merge(haloSelection);

    // Gentle restart — preserves zoom/pan, avoids full re-layout
    simulation.nodes(data.nodes);
    simulation.force("link").links(data.links);
    simulation.alpha(0.15).restart();
  }

  // ── Reusable node visual setup ─────────────────────
  function setupNodeVisuals(sel) {
    // OA rings
    sel.filter(function(d) { return d.type === "paper"; }).append("circle")
      .attr("class", "oa-ring")
      .attr("r", function(d) { return d.size + 2.5; })
      .attr("fill", "none")
      .each(function(d) {
        var oa = (d.metadata && d.metadata.oa_status) || "closed";
        var cfg = OA[oa] || OA.closed;
        d3.select(this).attr("stroke", cfg.color).attr("stroke-width", 1.5).attr("opacity", 0.5);
        if (cfg.dash) d3.select(this).attr("stroke-dasharray", cfg.dash);
      });
    // Researcher outer ring
    sel.filter(function(d) { return d.type === "researcher"; }).append("circle")
      .attr("class", "outer-ring")
      .attr("r", function(d) { return d.size + 3; })
      .attr("fill", "none").attr("stroke", function(d) { return d.color; })
      .attr("stroke-width", 0.4).attr("opacity", 0.15);
    // Domain outer ring
    sel.filter(function(d) { return d.type === "domain"; }).append("circle")
      .attr("class", "outer-ring")
      .attr("r", function(d) { return d.size + 5; })
      .attr("fill", "none").attr("stroke", function(d) { return d.color; })
      .attr("stroke-width", 0.6).attr("opacity", 0.12).attr("stroke-dasharray", "4,3");
    // Field outer ring
    sel.filter(function(d) { return d.type === "field"; }).append("circle")
      .attr("class", "outer-ring")
      .attr("r", function(d) { return d.size + 2; })
      .attr("fill", "none").attr("stroke", function(d) { return d.color; })
      .attr("stroke-width", 0.5).attr("opacity", 0.2);
    // Main body
    sel.append("circle").attr("class", "body")
      .attr("r", function(d) { return d.size; })
      .attr("fill", function(d) { return "url(#ng-" + d.id.replace(/[^a-zA-Z0-9]/g, "_") + ")"; })
      .attr("stroke", function(d) { return d.type === "query" ? "#c45c4a" : (d._authorColor || d.color); })
      .attr("stroke-width", function(d) {
        if (d.type === "domain") return 0.4; if (d.type === "field") return 0.6;
        return d.type === "researcher" ? 1.5 : d.type === "query" ? 1.2 : 0.8;
      })
      .attr("stroke-dasharray", function(d) { return d.type === "query" ? "3,2" : d.type === "domain" ? "4,3" : null; })
      .attr("opacity", function(d) { if (d.type === "domain") return 0.25; if (d.type === "field") return 0.5; return 0.9; })
      .attr("filter", function(d) { return (d.type === "researcher" || d.type === "query") ? "url(#glow)" : null; });
    // Icons
    sel.filter(function(d) { return d.type === "researcher"; }).append("text")
      .text("\u25CE").attr("text-anchor", "middle").attr("dy", 4).attr("font-size", "12px")
      .attr("fill", function(d) { return d.color; }).attr("opacity", 0.3).style("pointer-events", "none");
    sel.filter(function(d) { return d.type === "query"; }).append("text")
      .text("\u2299").attr("text-anchor", "middle").attr("dy", 4).attr("font-size", "10px")
      .attr("fill", "#c45c4a").attr("opacity", 0.35).style("pointer-events", "none");
    sel.filter(function(d) { return d.type === "field"; }).append("text")
      .text("\u25C7").attr("text-anchor", "middle").attr("dy", 4).attr("font-size", "9px")
      .attr("fill", function(d) { return d.color; }).attr("opacity", 0.25).style("pointer-events", "none");
    sel.filter(function(d) { return d.type === "domain"; }).append("text")
      .text("\u2B21").attr("text-anchor", "middle").attr("dy", 5).attr("font-size", "14px")
      .attr("fill", function(d) { return d.color; }).attr("opacity", 0.15).style("pointer-events", "none");
    // Labels
    sel.append("text").attr("class", "label")
      .text(function(d) { return d.label.length > 24 ? d.label.slice(0, 22) + "\u2026" : d.label; })
      .attr("text-anchor", "middle").attr("dy", function(d) { return -d.size - 6; })
      .attr("font-size", function(d) {
        if (d.type === "domain") return "10px"; if (d.type === "field") return "7.5px";
        return d.type === "researcher" ? "9px" : d.type === "query" ? "8px" : "6.5px";
      })
      .attr("font-weight", function(d) {
        return (d.type === "researcher" || d.type === "query" || d.type === "domain") ? 600 : d.type === "field" ? 500 : 400;
      })
      .attr("fill", function(d) {
        if (d.type === "domain") return d.color; if (d.type === "field") return d.color;
        return d.type === "query" ? "#c45c4a" : d.type === "researcher" ? d.color : "#6a7590";
      })
      .attr("opacity", function(d) { if (d.type === "domain") return 0.25; if (d.type === "field") return 0.45; return 1; })
      .attr("letter-spacing", function(d) { return (d.type === "researcher" || d.type === "domain") ? "0.8px" : "0.2px"; })
      .attr("font-family", "inherit").style("pointer-events", "none");
    // Sub-labels
    sel.append("text").attr("class", "sub-label")
      .text(function(d) {
        if (d.type === "researcher") { var m = d.metadata || {}; return "h-index: " + (m.h_index || "?") + " \u00B7 " + ((m.affiliations && m.affiliations[0]) || ""); }
        if (d.type === "paper") { var m2 = d.metadata || {}; return (m2.year || "") + " \u00B7 " + (m2.citations || 0) + " cites"; }
        if (d.type === "field" || d.type === "domain") { var conn = getConnected(d.id); return (conn.size - 1) + " connected"; }
        return "";
      })
      .attr("text-anchor", "middle").attr("dy", function(d) { return d.size + 12; })
      .attr("font-size", "6px").attr("fill", "#4a5568").attr("opacity", 0)
      .attr("font-family", "inherit").style("pointer-events", "none");
    // Field tags
    sel.filter(function(d) { return d.type === "paper"; }).append("text").attr("class", "field-tag")
      .text(function(d) { return (d.metadata && d.metadata.fields && d.metadata.fields[0]) || ""; })
      .attr("text-anchor", "middle").attr("dy", function(d) { return d.size + 22; })
      .attr("font-size", "5.5px").attr("fill", function(d) { return d._authorColor || d.color; }).attr("opacity", 0)
      .attr("font-family", "inherit").style("pointer-events", "none");
  }

  // ── Simulation ────────────────────────────────────
  var simulation = d3.forceSimulation(data.nodes)
    .force("link", d3.forceLink(data.links).id(function(d) { return d.id; })
      .distance(function(d) {
        if (d.type === "domain_mapping") return 80;
        if (d.type === "field_membership") return 65;
        if (d.type === "authorship") return 55 + ((nodeMap[d.target.id || d.target] || {}).size || 10) * 2;
        if (d.type === "semantic") return 100;
        return 140;
      })
      .strength(function(d) {
        if (d.type === "domain_mapping") return 0.15;
        if (d.type === "field_membership") return 0.12;
        if (d.type === "authorship") return 0.6;
        if (d.type === "citation") return 0.08;
        if (d.type === "semantic") return (d.metadata && d.metadata.score || 0.3) * 0.4;
        return 0.2;
      }))
    .force("charge", d3.forceManyBody().strength(function(d) {
      if (d.type === "domain") return -500;
      if (d.type === "field") return -120;
      return d.type === "researcher" ? -280 : d.type === "query" ? -200 : -50;
    }))
    .force("center", d3.forceCenter(width / 2, height / 2).strength(0.03))
    .force("collision", d3.forceCollide().radius(function(d) { return d.size + 8; }).strength(0.7))
    .alpha(0.8)
    .alphaDecay(0.03)
    .alphaMin(0.003)
    .velocityDecay(0.55)
    .on("tick", function() {
      link.attr("x1", function(d) { return d.source.x; }).attr("y1", function(d) { return d.source.y; })
          .attr("x2", function(d) { return d.target.x; }).attr("y2", function(d) { return d.target.y; });
      scoreLabels
        .attr("x", function(d) { return (d.source.x + d.target.x) / 2; })
        .attr("y", function(d) { return (d.source.y + d.target.y) / 2 - 4; });
      node.attr("transform", function(d) { return "translate(" + d.x + "," + d.y + ")"; });
      haloSelection
        .attr("cx", function(d) { return d.x; }).attr("cy", function(d) { return d.y; });
    });

  // ── Apply initial layer emphasis after short delay ────
  setTimeout(function() { applyLayerEmphasis(activeLayer); }, 600);
})();
</script>
